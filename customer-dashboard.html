<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            name="description"
            content="Customer Dashboard - View orders and manage account"
        />
        <title>My Account - MoonCart</title>

        <!-- Favicon -->
        <link
            rel="icon"
            type="image/svg+xml"
            href="assets/images/favicon.svg"
        />

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />

        <!-- Font Awesome -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />

        <!-- Stylesheets -->
        <link rel="stylesheet" href="css/main.css" />
        <link rel="stylesheet" href="css/responsive.css" />

        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    </head>
    <body>
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="container">
                <div class="top-bar-content">
                    <div class="top-bar-left">
                        <span
                            ><i class="fas fa-phone-alt"></i> +1 234 567
                            8900</span
                        >
                        <span
                            ><i class="fas fa-envelope"></i>
                            info@mooncart.com</span
                        >
                    </div>
                    <div class="top-bar-right">
                        <span class="delivery-badge"
                            ><i class="fas fa-shipping-fast"></i> Free delivery
                            on orders over $50</span
                        >
                        <div class="social-icons">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="header">
            <div class="container">
                <nav class="navbar">
                    <a href="index.html" class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-moon"></i>
                        </div>
                        <div class="logo-text">
                            <span class="logo-main"
                                >Moon<span class="logo-accent">Cart</span></span
                            >
                            <span class="logo-tagline">Fresh & Fast</span>
                        </div>
                    </a>

                    <ul class="nav-menu">
                        <li>
                            <a href="index.html" class="nav-link">
                                <i class="fas fa-home"></i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li>
                            <a href="products.html" class="nav-link">
                                <i class="fas fa-utensils"></i>
                                <span>Products</span>
                            </a>
                        </li>
                        <li>
                            <a href="about.html" class="nav-link">
                                <i class="fas fa-info-circle"></i>
                                <span>About</span>
                            </a>
                        </li>
                        <li>
                            <a href="contact.html" class="nav-link">
                                <i class="fas fa-envelope"></i>
                                <span>Contact</span>
                            </a>
                        </li>
                        <li>
                            <a href="product-requests.html" class="nav-link">
                                <i class="fas fa-comments"></i>
                                <span>Product Requests</span>
                            </a>
                        </li>
                    </ul>

                    <div class="nav-actions">
                        <a href="cart.html" class="cart-icon-wrapper">
                            <div class="cart-icon">
                                <i class="fas fa-shopping-bag"></i>
                                <span class="cart-count">0</span>
                            </div>
                            <span class="cart-text">Cart</span>
                        </a>
                        <!-- Account Section (Dynamic) -->
                        <div id="account-section" class="account-section">
                            <div class="auth-buttons">
                                <a href="login.html" class="btn-login">
                                    <i class="fas fa-sign-in-alt"></i>
                                    <span>Login</span>
                                </a>
                                <a href="signup.html" class="btn-signup">
                                    <i class="fas fa-user-plus"></i>
                                    <span>Sign Up</span>
                                </a>
                            </div>
                        </div>

                        <div class="menu-toggle">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Dashboard -->
        <div class="dashboard">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-divider">
                    <span>MAIN MENU</span>
                </div>

                <div class="sidebar-menu">
                    <a
                        href="#dashboard"
                        class="sidebar-link active"
                        onclick="showSection('dashboard')"
                    >
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <a
                        href="#orders"
                        class="sidebar-link"
                        onclick="showSection('orders')"
                    >
                        <i class="fas fa-shopping-bag"></i> My Orders
                    </a>
                    <a
                        href="#addresses"
                        class="sidebar-link"
                        onclick="showSection('addresses')"
                    >
                        <i class="fas fa-map-marker-alt"></i> Addresses
                    </a>
                    <a
                        href="#profile"
                        class="sidebar-link"
                        onclick="showSection('profile')"
                    >
                        <i class="fas fa-user"></i> Profile
                    </a>

                    <div class="sidebar-divider">
                        <span>ACCOUNT</span>
                    </div>

                    <a
                        href="javascript:logout()"
                        class="sidebar-link sidebar-link-logout"
                    >
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="dashboard-content">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="dashboard-section">
                    <h2
                        style="
                            margin-bottom: 30px;
                            font-size: 28px;
                            font-weight: 700;
                            color: var(--text-dark);
                        "
                    >
                        Welcome, <span id="welcome-name">John</span>!
                    </h2>

                    <!-- Stats Grid - Modern Cards -->
                    <div
                        style="
                            display: grid;
                            grid-template-columns: repeat(
                                auto-fit,
                                minmax(240px, 1fr)
                            );
                            gap: 20px;
                            margin-bottom: 30px;
                        "
                    >
                        <!-- Total Orders Card -->
                        <div
                            style="
                                background: linear-gradient(
                                    135deg,
                                    #667eea 0%,
                                    #764ba2 100%
                                );
                                padding: 25px;
                                border-radius: 15px;
                                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
                                color: white;
                                position: relative;
                                overflow: hidden;
                            "
                        >
                            <div
                                style="
                                    position: absolute;
                                    top: -20px;
                                    right: -20px;
                                    font-size: 100px;
                                    opacity: 0.2;
                                "
                            >
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div style="position: relative; z-index: 1">
                                <div
                                    style="
                                        font-size: 14px;
                                        opacity: 0.9;
                                        margin-bottom: 8px;
                                        text-transform: uppercase;
                                        letter-spacing: 1px;
                                    "
                                >
                                    Total Orders
                                </div>
                                <div
                                    style="
                                        font-size: 36px;
                                        font-weight: 700;
                                        margin-bottom: 5px;
                                    "
                                >
                                    8
                                </div>
                                <div style="font-size: 13px; opacity: 0.8">
                                    <i class="fas fa-arrow-up"></i> 2 from last
                                    month
                                </div>
                            </div>
                        </div>

                        <!-- Pending Orders Card -->
                        <div
                            style="
                                background: linear-gradient(
                                    135deg,
                                    #fa709a 0%,
                                    #fee140 100%
                                );
                                padding: 25px;
                                border-radius: 15px;
                                box-shadow: 0 10px 30px rgba(250, 112, 154, 0.4);
                                color: white;
                                position: relative;
                                overflow: hidden;
                            "
                        >
                            <div
                                style="
                                    position: absolute;
                                    top: -20px;
                                    right: -20px;
                                    font-size: 100px;
                                    opacity: 0.2;
                                "
                            >
                                <i class="fas fa-clock"></i>
                            </div>
                            <div style="position: relative; z-index: 1">
                                <div
                                    style="
                                        font-size: 14px;
                                        opacity: 0.9;
                                        margin-bottom: 8px;
                                        text-transform: uppercase;
                                        letter-spacing: 1px;
                                    "
                                >
                                    Pending Orders
                                </div>
                                <div
                                    style="
                                        font-size: 36px;
                                        font-weight: 700;
                                        margin-bottom: 5px;
                                    "
                                >
                                    2
                                </div>
                                <div style="font-size: 13px; opacity: 0.8">
                                    <i class="fas fa-check"></i> Ready for
                                    delivery
                                </div>
                            </div>
                        </div>

                        <!-- Total Spent Card -->
                        <div
                            style="
                                background: linear-gradient(
                                    135deg,
                                    #f093fb 0%,
                                    #f5576c 100%
                                );
                                padding: 25px;
                                border-radius: 15px;
                                box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
                                color: white;
                                position: relative;
                                overflow: hidden;
                            "
                        >
                            <div
                                style="
                                    position: absolute;
                                    top: -20px;
                                    right: -20px;
                                    font-size: 100px;
                                    opacity: 0.2;
                                "
                            >
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div style="position: relative; z-index: 1">
                                <div
                                    style="
                                        font-size: 14px;
                                        opacity: 0.9;
                                        margin-bottom: 8px;
                                        text-transform: uppercase;
                                        letter-spacing: 1px;
                                    "
                                >
                                    Total Spent
                                </div>
                                <div
                                    style="
                                        font-size: 36px;
                                        font-weight: 700;
                                        margin-bottom: 5px;
                                    "
                                >
                                    ৳485.50
                                </div>
                                <div style="font-size: 13px; opacity: 0.8">
                                    <i class="fas fa-chart-line"></i> ৳125 this
                                    month
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div
                        style="
                            display: grid;
                            grid-template-columns: 2fr 1fr;
                            gap: 20px;
                            margin-bottom: 30px;
                        "
                    >
                        <!-- Spending Chart -->
                        <div
                            style="
                                background: white;
                                padding: 25px;
                                border-radius: 15px;
                                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
                            "
                        >
                            <h3
                                style="
                                    margin-bottom: 20px;
                                    font-size: 18px;
                                    font-weight: 600;
                                    color: var(--text-dark);
                                "
                            >
                                <i
                                    class="fas fa-chart-area"
                                    style="
                                        color: var(--primary-color);
                                        margin-right: 8px;
                                    "
                                ></i>
                                Monthly Spending
                            </h3>
                            <canvas
                                id="customerSpendingChart"
                                style="max-height: 300px"
                            ></canvas>
                        </div>

                        <!-- Order Status Pie Chart -->
                        <div
                            style="
                                background: white;
                                padding: 25px;
                                border-radius: 15px;
                                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
                            "
                        >
                            <h3
                                style="
                                    margin-bottom: 20px;
                                    font-size: 18px;
                                    font-weight: 600;
                                    color: var(--text-dark);
                                "
                            >
                                <i
                                    class="fas fa-chart-pie"
                                    style="
                                        color: var(--primary-color);
                                        margin-right: 8px;
                                    "
                                ></i>
                                Order Categories
                            </h3>
                            <canvas
                                id="customerCategoryChart"
                                style="max-height: 300px"
                            ></canvas>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div
                        style="
                            background: white;
                            padding: 30px;
                            border-radius: var(--border-radius);
                            box-shadow: var(--shadow);
                            margin-top: 30px;
                        "
                    >
                        <h3 style="margin-bottom: 20px">Quick Actions</h3>
                        <div
                            style="
                                display: grid;
                                grid-template-columns: repeat(
                                    auto-fit,
                                    minmax(200px, 1fr)
                                );
                                gap: 15px;
                            "
                        >
                            <button
                                class="btn btn-primary"
                                onclick="window.location.href='products.html'"
                            >
                                <i class="fas fa-shopping-cart"></i> Continue
                                Shopping
                            </button>
                            <button
                                class="btn btn-secondary"
                                onclick="window.location.href='cart.html'"
                            >
                                <i class="fas fa-shopping-bag"></i> View Cart
                            </button>
                            <button
                                class="btn btn-outline"
                                onclick="showSection('orders')"
                            >
                                <i class="fas fa-list"></i> Track Orders
                            </button>
                            <button
                                class="btn btn-outline"
                                onclick="window.location.href='product-requests.html'"
                            >
                                <i class="fas fa-plus"></i> Request Product
                            </button>
                        </div>
                    </div>

                    <!-- Recent Orders -->
                    <div
                        style="
                            background: white;
                            padding: 30px;
                            border-radius: var(--border-radius);
                            box-shadow: var(--shadow);
                            margin-top: 30px;
                        "
                    >
                        <h3 style="margin-bottom: 20px">Recent Orders</h3>
                        <div id="customer-orders">
                            <!-- Orders will be dynamically inserted here -->
                        </div>
                    </div>
                </section>

                <!-- Orders Section -->
                <section
                    id="orders-section"
                    class="dashboard-section"
                    style="display: none"
                >
                    <div
                        style="
                            background: white;
                            padding: 30px;
                            border-radius: var(--border-radius);
                            box-shadow: var(--shadow);
                        "
                    >
                        <div style="margin-bottom: 20px">
                            <input
                                type="text"
                                id="order-search"
                                class="form-input"
                                placeholder="Search orders by ID, items, or status..."
                                style="max-width: 400px; margin: 0"
                                onkeyup="searchOrders()"
                            />
                        </div>

                        <div id="customer-orders-full">
                            <!-- Full orders list will be inserted here -->
                        </div>
                    </div>
                </section>

                <!-- Addresses Section -->
                <section
                    id="addresses-section"
                    class="dashboard-section"
                    style="display: none"
                >
                    <div style="margin-bottom: 20px">
                        <button
                            class="btn btn-primary"
                            onclick="openModal('add-address-modal')"
                        >
                            <i class="fas fa-plus"></i> Add New Address
                        </button>
                    </div>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: repeat(
                                auto-fill,
                                minmax(300px, 1fr)
                            );
                            gap: 20px;
                        "
                    >
                        <div
                            style="
                                background: white;
                                padding: 25px;
                                border-radius: var(--border-radius);
                                box-shadow: var(--shadow);
                                border-left: 4px solid var(--primary-color);
                            "
                        >
                            <div
                                style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: start;
                                    margin-bottom: 15px;
                                "
                            >
                                <h4><i class="fas fa-home"></i> Home</h4>
                                <span
                                    style="
                                        background: var(--primary-color);
                                        color: white;
                                        padding: 3px 10px;
                                        border-radius: 12px;
                                        font-size: 12px;
                                    "
                                    >Default</span
                                >
                            </div>
                            <p
                                style="
                                    color: var(--text-light);
                                    margin-bottom: 15px;
                                "
                            >
                                123 Main Street, Apt 4B<br />
                                New York, NY 10001<br />
                                Phone: +1 234 567 8900
                            </p>
                            <div style="display: flex; gap: 10px">
                                <button
                                    class="btn btn-sm"
                                    onclick="editAddress('home')"
                                >
                                    Edit
                                </button>
                                <button
                                    class="btn btn-sm"
                                    style="background: var(--danger-color)"
                                    onclick="deleteAddress('home')"
                                >
                                    Delete
                                </button>
                            </div>
                        </div>

                        <div
                            style="
                                background: white;
                                padding: 25px;
                                border-radius: var(--border-radius);
                                box-shadow: var(--shadow);
                            "
                        >
                            <h4 style="margin-bottom: 15px">
                                <i class="fas fa-briefcase"></i> Office
                            </h4>
                            <p
                                style="
                                    color: var(--text-light);
                                    margin-bottom: 15px;
                                "
                            >
                                456 Corporate Ave, Suite 200<br />
                                New York, NY 10002<br />
                                Phone: +1 234 567 8900
                            </p>
                            <div style="display: flex; gap: 10px">
                                <button
                                    class="btn btn-sm"
                                    onclick="editAddress('office')"
                                >
                                    Edit
                                </button>
                                <button
                                    class="btn btn-sm"
                                    style="background: var(--danger-color)"
                                    onclick="deleteAddress('office')"
                                >
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Profile Section -->
                <section
                    id="profile-section"
                    class="dashboard-section"
                    style="display: none"
                >
                    <div
                        style="
                            background: white;
                            padding: 30px;
                            border-radius: var(--border-radius);
                            box-shadow: var(--shadow);
                        "
                    >
                        <form id="profile-form" onsubmit="updateProfile(event)">
                            <div
                                style="text-align: center; margin-bottom: 30px"
                            >
                                <div
                                    id="profile-avatar"
                                    style="
                                        width: 120px;
                                        height: 120px;
                                        background: var(--primary-color);
                                        border-radius: 50%;
                                        display: inline-flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 48px;
                                        font-weight: 700;
                                        color: white;
                                        margin-bottom: 15px;
                                    "
                                >
                                    JD
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input
                                    type="text"
                                    id="profile-name"
                                    class="form-input"
                                    placeholder="Enter your full name"
                                    required
                                />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input
                                    type="email"
                                    id="profile-email"
                                    class="form-input"
                                    readonly
                                    style="
                                        background: #f5f5f5;
                                        cursor: not-allowed;
                                    "
                                />
                                <small style="color: var(--text-light)"
                                    >Email cannot be changed</small
                                >
                            </div>

                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input
                                    type="tel"
                                    id="profile-phone"
                                    class="form-input"
                                    placeholder="Enter your phone number"
                                />
                            </div>

                            <hr style="margin: 30px 0" />

                            <h3 style="margin-bottom: 20px">
                                Change Password (optional)
                            </h3>

                            <div
                                style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 20px;
                                "
                            >
                                <div class="form-group">
                                    <label class="form-label"
                                        >New Password</label
                                    >
                                    <input
                                        type="password"
                                        id="profile-new-password"
                                        class="form-input"
                                        placeholder="Leave blank to keep current"
                                    />
                                </div>

                                <div class="form-group">
                                    <label class="form-label"
                                        >Confirm Password</label
                                    >
                                    <input
                                        type="password"
                                        id="profile-confirm-password"
                                        class="form-input"
                                        placeholder="Confirm new password"
                                    />
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </form>
                    </div>
                </section>
            </main>
        </div>

        <!-- Order Details Modal -->
        <div
            id="order-details-modal"
            class="modal"
            style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
            "
        >
            <div
                class="modal-content"
                style="
                    max-width: 900px;
                    background: white;
                    border-radius: 12px;
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                "
            >
                <span
                    class="modal-close"
                    onclick="document.getElementById('order-details-modal').style.display='none'"
                    style="
                        position: absolute;
                        right: 20px;
                        top: 20px;
                        font-size: 28px;
                        cursor: pointer;
                        color: #999;
                        z-index: 1;
                    "
                    >&times;</span
                >
                <div id="order-details"></div>
            </div>
        </div>

        <!-- Custom Received Confirmation Dialog -->
        <div
            id="received-confirm-dialog"
            class="custom-confirm-dialog"
            style="display: none"
        >
            <div class="custom-confirm-content">
                <div class="custom-confirm-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 class="custom-confirm-title">Confirm Order Received</h3>
                <p class="custom-confirm-message">
                    Have you received this order? This will mark it as
                    completed.
                </p>
                <div class="custom-confirm-buttons">
                    <button
                        class="custom-confirm-btn custom-confirm-cancel"
                        onclick="closeReceivedDialog()"
                    >
                        Cancel
                    </button>
                    <button
                        class="custom-confirm-btn custom-confirm-ok"
                        onclick="confirmReceivedOrder()"
                    >
                        Yes, I Received It
                    </button>
                </div>
            </div>
        </div>

        <style>
            .custom-confirm-dialog {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            }

            .custom-confirm-content {
                background: white;
                border-radius: 20px;
                padding: 40px;
                max-width: 450px;
                width: 90%;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease-out;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-30px) scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .custom-confirm-icon {
                width: 80px;
                height: 80px;
                margin: 0 auto 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 40px;
                color: white;
                box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
            }

            .custom-confirm-title {
                font-size: 24px;
                font-weight: 700;
                color: var(--text-dark);
                margin: 0 0 15px;
            }

            .custom-confirm-message {
                font-size: 16px;
                color: var(--text-light);
                margin: 0 0 30px;
                line-height: 1.6;
            }

            .custom-confirm-buttons {
                display: flex;
                gap: 15px;
                justify-content: center;
            }

            .custom-confirm-btn {
                padding: 12px 30px;
                border: none;
                border-radius: 8px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 140px;
            }

            .custom-confirm-cancel {
                background: #f0f0f0;
                color: var(--text-dark);
            }

            .custom-confirm-cancel:hover {
                background: #e0e0e0;
                transform: translateY(-2px);
            }

            .custom-confirm-ok {
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            }

            .custom-confirm-ok:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            }
        </style>

        <!-- Scripts -->
        <script src="js/main.js"></script>
        <script src="js/api.js"></script>
        <script src="js/cart.js"></script>
        <script src="js/order.js"></script>
        <script src="js/ui.js"></script>
        <script>
            // Check if user is logged in - redirect to login if not
            const currentUser = MoonCart.getCurrentUser();
            if (!currentUser) {
                window.location.href = "login.html";
            }

            // Global variables for data
            let userOrders = [];
            let userAddresses = [];
            let userProfile = currentUser;

            // Load all data from backend
            async function loadDashboardData() {
                if (!currentUser || !currentUser.id) return;

                // Update welcome message
                const welcomeNameEl = document.getElementById("welcome-name");
                if (welcomeNameEl) {
                    welcomeNameEl.textContent = currentUser.name
                        ? currentUser.name.split(" ")[0]
                        : "User";
                }

                // Load orders
                await loadUserOrders();

                // Load addresses
                await loadUserAddresses();

                // Load profile
                await loadUserProfile();

                // Update stats
                updateDashboardStats();
            }

            // Load orders from backend
            async function loadUserOrders() {
                try {
                    const response = await MoonCartAPI.getUserOrders(
                        currentUser.id
                    );
                    if (response.success && response.orders) {
                        userOrders = response.orders;
                        renderCustomerOrdersFromBackend();
                        renderFullOrdersList();
                    }
                } catch (error) {
                    console.log("Could not load orders:", error.message);
                    userOrders = [];
                    renderEmptyOrders();
                }
            }

            // Load addresses from backend
            async function loadUserAddresses() {
                try {
                    const response = await MoonCartAPI.getAddresses(
                        currentUser.id
                    );
                    if (response.success && response.addresses) {
                        userAddresses = response.addresses;
                        renderAddresses();
                    }
                } catch (error) {
                    console.log("Could not load addresses:", error.message);
                    userAddresses = [];
                    renderEmptyAddresses();
                }
            }

            // Load profile from backend
            async function loadUserProfile() {
                try {
                    const response = await MoonCartAPI.getProfile(
                        currentUser.id
                    );
                    if (response.success && response.user) {
                        userProfile = response.user;
                        renderProfile();
                    }
                } catch (error) {
                    console.log("Could not load profile:", error.message);
                    renderProfile();
                }
            }

            // Update dashboard stats
            function updateDashboardStats() {
                const totalOrders = userOrders.length;
                const pendingOrders = userOrders.filter(
                    (o) => o.status === "pending" || o.status === "confirmed"
                ).length;
                const totalSpent = userOrders.reduce(
                    (sum, o) => sum + parseFloat(o.total || 0),
                    0
                );

                // Update stat cards (they have inline styles, so we update text content)
                const statCards = document.querySelectorAll(
                    '[style*="font-size: 36px"]'
                );
                if (statCards.length >= 3) {
                    statCards[0].textContent = totalOrders;
                    statCards[1].textContent = pendingOrders;
                    statCards[2].textContent = "৳" + totalSpent.toFixed(2);
                }
            }

            // Render orders in dashboard
            function renderCustomerOrdersFromBackend() {
                const container = document.getElementById("customer-orders");
                if (!container) return;

                if (userOrders.length === 0) {
                    renderEmptyOrders();
                    return;
                }

                const recentOrders = userOrders.slice(0, 5);
                container.innerHTML =
                    '<table class="data-table"><thead><tr><th>Order ID</th><th>Date</th><th>Items</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead><tbody>' +
                    recentOrders
                        .map((order) => {
                            const orderId = String(order.id || "").trim();
                            if (!orderId) return ""; // Skip if no order ID
                            const isConfirmed = order.status === "confirmed";
                            const receivedButton = isConfirmed
                                ? '<button class="btn btn-sm btn-success" onclick="markOrderAsReceived(\'' +
                                  orderId.replace(/'/g, "\\'") +
                                  '\')" style="background: #28a745; color: white; margin-left: 5px;"><i class="fas fa-check"></i> Received</button>'
                                : "";
                            return (
                                "<tr><td>#" +
                                (order.order_number || order.id)
                                    .toString()
                                    .substring(0, 12)
                                    .toUpperCase() +
                                "</td><td>" +
                                formatDate(
                                    order.created_at || order.orderDate
                                ) +
                                "</td><td>" +
                                (order.item_count || order.items?.length || 0) +
                                " items</td><td>৳" +
                                parseFloat(order.total).toFixed(2) +
                                '</td><td><span class="status-badge status-' +
                                order.status +
                                '">' +
                                order.status +
                                '</span></td><td><button class="btn btn-sm" onclick="viewOrderDetails(\'' +
                                orderId.replace(/'/g, "\\'") +
                                "')\">View</button>" +
                                receivedButton +
                                "</td></tr>"
                            );
                        })
                        .join("") +
                    "</tbody></table>";
            }

            // Render empty orders state
            function renderEmptyOrders() {
                const container = document.getElementById("customer-orders");
                if (!container) return;
                container.innerHTML =
                    '<div class="empty-state"><h3>No orders yet</h3><p>Start shopping to see your orders here!</p><a href="products.html" class="btn btn-primary">Browse Products</a></div>';
            }

            // Render full orders list
            function renderFullOrdersList() {
                const container = document.getElementById(
                    "customer-orders-full"
                );
                if (!container) return;

                if (userOrders.length === 0) {
                    container.innerHTML =
                        '<div class="empty-state"><h3>No orders yet</h3><p>Start shopping to see your orders here!</p></div>';
                    return;
                }

                container.innerHTML =
                    '<table class="data-table"><thead><tr><th>Order ID</th><th>Date</th><th>Items</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead><tbody>' +
                    userOrders
                        .map((order) => {
                            const orderId = String(order.id || "").trim();
                            if (!orderId) return ""; // Skip if no order ID
                            const isConfirmed = order.status === "confirmed";
                            const receivedButton = isConfirmed
                                ? '<button class="btn btn-sm btn-success" onclick="markOrderAsReceived(\'' +
                                  orderId.replace(/'/g, "\\'") +
                                  '\')" style="background: #28a745; color: white; margin-left: 5px;"><i class="fas fa-check"></i> Received</button>'
                                : "";
                            return (
                                "<tr><td>#" +
                                (order.order_number || order.id)
                                    .toString()
                                    .substring(0, 12)
                                    .toUpperCase() +
                                "</td><td>" +
                                formatDate(
                                    order.created_at || order.orderDate
                                ) +
                                "</td><td>" +
                                (order.item_count || order.items?.length || 0) +
                                " items</td><td>৳" +
                                parseFloat(order.total).toFixed(2) +
                                '</td><td><span class="status-badge status-' +
                                order.status +
                                '">' +
                                order.status +
                                '</span></td><td><button class="btn btn-sm" onclick="viewOrderDetails(\'' +
                                orderId.replace(/'/g, "\\'") +
                                "')\">View</button>" +
                                receivedButton +
                                "</td></tr>"
                            );
                        })
                        .join("") +
                    "</tbody></table>";
            }

            // Render addresses
            function renderAddresses() {
                const container = document.querySelector(
                    "#addresses-section > div:last-child"
                );
                if (!container) return;

                if (userAddresses.length === 0) {
                    renderEmptyAddresses();
                    return;
                }

                container.innerHTML = userAddresses
                    .map(
                        (addr) =>
                            '<div style="background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow);' +
                            (addr.is_default
                                ? "border-left: 4px solid var(--primary-color);"
                                : "") +
                            '">' +
                            '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">' +
                            '<h4><i class="fas fa-' +
                            (addr.label === "Home" ? "home" : "briefcase") +
                            '"></i> ' +
                            (addr.label || "Address") +
                            "</h4>" +
                            (addr.is_default
                                ? '<span style="background: var(--primary-color); color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">Default</span>'
                                : "") +
                            "</div>" +
                            '<p style="color: var(--text-light); margin-bottom: 15px;">' +
                            addr.address_line +
                            "<br>" +
                            addr.city +
                            ", " +
                            (addr.zip_code || addr.postal_code || "") +
                            (addr.phone ? "<br>Phone: " + addr.phone : "") +
                            "</p>" +
                            '<div style="display: flex; gap: 10px;">' +
                            '<button class="btn btn-sm" onclick="editAddress(' +
                            addr.id +
                            ')">Edit</button>' +
                            '<button class="btn btn-sm" style="background: var(--danger-color)" onclick="deleteAddressFromBackend(' +
                            addr.id +
                            ')">Delete</button>' +
                            "</div></div>"
                    )
                    .join("");
            }

            // Render empty addresses
            function renderEmptyAddresses() {
                const container = document.querySelector(
                    "#addresses-section > div:last-child"
                );
                if (!container) return;
                container.innerHTML =
                    '<div style="background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center;"><p>No addresses saved yet.</p><button class="btn btn-primary" onclick="openModal(\'add-address-modal\')"><i class="fas fa-plus"></i> Add Address</button></div>';
            }

            // Render profile
            function renderProfile() {
                const nameInput = document.getElementById("profile-name");
                const emailInput = document.getElementById("profile-email");
                const phoneInput = document.getElementById("profile-phone");
                const avatarDiv = document.getElementById("profile-avatar");

                if (userProfile) {
                    if (nameInput) nameInput.value = userProfile.name || "";
                    if (emailInput) emailInput.value = userProfile.email || "";
                    if (phoneInput) phoneInput.value = userProfile.phone || "";
                    if (avatarDiv) {
                        const initials = (
                            userProfile.name ||
                            userProfile.email ||
                            "U"
                        )
                            .split(" ")
                            .map((n) => n[0])
                            .join("")
                            .toUpperCase()
                            .substring(0, 2);
                        avatarDiv.textContent = initials;
                    }
                }
            }

            // Update profile via API
            async function updateProfile(event) {
                event.preventDefault();

                const name = document
                    .getElementById("profile-name")
                    .value.trim();
                const phone = document
                    .getElementById("profile-phone")
                    .value.trim();
                const newPassword = document.getElementById(
                    "profile-new-password"
                ).value;
                const confirmPassword = document.getElementById(
                    "profile-confirm-password"
                ).value;

                if (!name) {
                    MoonCart.showNotification("Name is required", "error");
                    return;
                }

                if (newPassword && newPassword !== confirmPassword) {
                    MoonCart.showNotification(
                        "Passwords do not match",
                        "error"
                    );
                    return;
                }

                const updateData = {
                    id: currentUser.id,
                    name: name,
                    phone: phone,
                };

                if (newPassword) {
                    updateData.password = newPassword;
                }

                try {
                    MoonCart.showLoading();
                    const response = await MoonCartAPI.updateProfile(
                        updateData
                    );
                    MoonCart.hideLoading();

                    if (response.success) {
                        MoonCart.showNotification(
                            "Profile updated successfully!",
                            "success"
                        );

                        // Update local storage with new data
                        const updatedUser = {
                            ...currentUser,
                            name: name,
                            phone: phone,
                        };
                        localStorage.setItem(
                            "mooncart_user",
                            JSON.stringify(updatedUser)
                        );
                        userProfile = updatedUser;

                        // Update welcome name
                        const welcomeNameEl =
                            document.getElementById("welcome-name");
                        if (welcomeNameEl) {
                            welcomeNameEl.textContent = name.split(" ")[0];
                        }

                        // Clear password fields
                        document.getElementById("profile-new-password").value =
                            "";
                        document.getElementById(
                            "profile-confirm-password"
                        ).value = "";

                        // Re-render profile to update avatar
                        renderProfile();
                    } else {
                        MoonCart.showNotification(
                            response.message || "Failed to update profile",
                            "error"
                        );
                    }
                } catch (error) {
                    MoonCart.hideLoading();
                    MoonCart.showNotification(
                        error.message || "Failed to update profile",
                        "error"
                    );
                }
            }

            // Delete address from backend
            async function deleteAddressFromBackend(addressId) {
                if (!confirm("Are you sure you want to delete this address?"))
                    return;

                try {
                    const response = await MoonCartAPI.deleteAddress(addressId);
                    if (response.success) {
                        MoonCart.showNotification(
                            "Address deleted successfully",
                            "success"
                        );
                        loadUserAddresses();
                    } else {
                        MoonCart.showNotification(
                            response.message || "Failed to delete address",
                            "error"
                        );
                    }
                } catch (error) {
                    MoonCart.showNotification(
                        "Failed to delete address",
                        "error"
                    );
                }
            }

            // View order details
            async function viewOrderDetails(orderId) {
                try {
                    const response = await MoonCartAPI.getOrder(orderId);
                    if (response.success && response.order) {
                        const order = response.order;
                        const modal = document.getElementById(
                            "order-details-modal"
                        );
                        const detailsContainer =
                            document.getElementById("order-details");

                        if (modal && detailsContainer) {
                            // Delivery man info
                            const deliveryInfo = order.delivery_man_name
                                ? `
                                <div style="background: linear-gradient(135deg, #e8f4f8, #d1ecf1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid var(--primary-color);">
                                    <h3 style="margin: 0 0 15px; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-truck"></i> Delivery Information
                                    </h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        <div>
                                            <p style="margin: 5px 0; font-size: 13px; color: var(--text-light);">Delivery Man</p>
                                            <p style="margin: 0; font-weight: 600; color: var(--text-dark);">${
                                                order.delivery_man_name
                                            }</p>
                                        </div>
                                        <div>
                                            <p style="margin: 5px 0; font-size: 13px; color: var(--text-light);">Contact</p>
                                            <p style="margin: 0; font-weight: 600; color: var(--text-dark);">${
                                                order.delivery_man_phone ||
                                                "N/A"
                                            }</p>
                                        </div>
                                        <div>
                                            <p style="margin: 5px 0; font-size: 13px; color: var(--text-light);">Estimated Delivery</p>
                                            <p style="margin: 0; font-weight: 600; color: var(--text-dark);">${
                                                order.estimated_delivery_time
                                                    ? new Date(
                                                          order.estimated_delivery_time
                                                      ).toLocaleString()
                                                    : "N/A"
                                            }</p>
                                        </div>
                                    </div>
                                </div>
                            `
                                : "";

                            // Cancellation info
                            const cancellationInfo = order.cancellation_reason
                                ? `
                                <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                                    <h3 style="margin: 0 0 15px; color: #856404; display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-exclamation-triangle"></i> Order Cancelled
                                    </h3>
                                    <p style="margin: 0; color: #856404; font-weight: 600;">Reason: ${order.cancellation_reason}</p>
                                </div>
                            `
                                : "";

                            detailsContainer.innerHTML =
                                '<div style="padding: 20px;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--primary-color); padding-bottom: 15px;"><h2 style="margin: 0;">#' +
                                (order.order_number || order.id) +
                                '</h2><span class="status-badge status-' +
                                order.status +
                                '">' +
                                order.status +
                                "</span></div>" +
                                deliveryInfo +
                                cancellationInfo +
                                '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">' +
                                '<div style="background: var(--light-bg); padding: 20px; border-radius: 10px;"><h3 style="margin: 0 0 15px; color: var(--primary-color);">Customer</h3><p>' +
                                order.customer_name +
                                "</p><p>" +
                                order.email +
                                "</p><p>" +
                                order.phone +
                                "</p></div>" +
                                '<div style="background: var(--light-bg); padding: 20px; border-radius: 10px;"><h3 style="margin: 0 0 15px; color: var(--primary-color);">Delivery</h3><p>' +
                                order.address +
                                "</p><p>" +
                                order.city +
                                ", " +
                                (order.zip_code || "") +
                                "</p><p>Slot: " +
                                (order.delivery_slot || "N/A") +
                                "</p></div>" +
                                '<div style="background: var(--light-bg); padding: 20px; border-radius: 10px;"><h3 style="margin: 0 0 15px; color: var(--primary-color);">Summary</h3><p>Date: ' +
                                formatDate(order.created_at) +
                                "</p><p>Payment: " +
                                (order.payment_method || "Card") +
                                "</p><p>Total: ৳" +
                                parseFloat(order.total).toFixed(2) +
                                "</p></div>" +
                                "</div>";

                            if (order.items && order.items.length > 0) {
                                detailsContainer.innerHTML +=
                                    '<h3>Items</h3><table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: var(--primary-color); color: white;"><th style="padding: 12px; text-align: left;">Product</th><th style="padding: 12px;">Qty</th><th style="padding: 12px; text-align: right;">Price</th><th style="padding: 12px; text-align: right;">Total</th></tr></thead><tbody>' +
                                    order.items
                                        .map(
                                            (item, i) =>
                                                '<tr style="border-bottom: 1px solid #eee;' +
                                                (i % 2 === 0
                                                    ? "background: #f9f9f9;"
                                                    : "") +
                                                '"><td style="padding: 12px;">' +
                                                item.product_name +
                                                '</td><td style="padding: 12px; text-align: center;">' +
                                                item.quantity +
                                                '</td><td style="padding: 12px; text-align: right;">৳' +
                                                parseFloat(item.price).toFixed(
                                                    2
                                                ) +
                                                '</td><td style="padding: 12px; text-align: right;">৳' +
                                                parseFloat(item.total).toFixed(
                                                    2
                                                ) +
                                                "</td></tr>"
                                        )
                                        .join("") +
                                    "</tbody></table>";
                            }

                            detailsContainer.innerHTML += "</div>";
                            modal.style.display = "flex";
                        }
                    }
                } catch (error) {
                    console.error("Error loading order:", error);
                    MoonCart.showNotification(
                        "Could not load order details",
                        "error"
                    );
                }
            }

            // Format date helper
            function formatDate(dateStr) {
                if (!dateStr) return "N/A";
                const date = new Date(dateStr);
                return date.toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                });
            }

            // Store current order ID for received confirmation
            let currentReceivedOrderId = null;

            // Mark order as received (completed) - opens custom dialog
            function markOrderAsReceived(orderId) {
                if (!orderId) {
                    MoonCart.showNotification("Order ID is missing", "error");
                    return;
                }
                // Ensure orderId is a string (it might come as number or string)
                currentReceivedOrderId = String(orderId);
                const dialog = document.getElementById(
                    "received-confirm-dialog"
                );
                if (dialog) {
                    dialog.style.display = "flex";
                }
            }

            // Close received confirmation dialog
            function closeReceivedDialog() {
                const dialog = document.getElementById(
                    "received-confirm-dialog"
                );
                if (dialog) {
                    dialog.style.display = "none";
                }
                currentReceivedOrderId = null;
            }

            // Confirm received order
            async function confirmReceivedOrder() {
                if (!currentReceivedOrderId) {
                    MoonCart.showNotification(
                        "Order ID is missing. Please try again.",
                        "error"
                    );
                    closeReceivedDialog();
                    return;
                }

                // Ensure we have valid order ID and status
                const orderId = String(currentReceivedOrderId).trim();
                if (!orderId) {
                    MoonCart.showNotification(
                        "Invalid order ID. Please try again.",
                        "error"
                    );
                    closeReceivedDialog();
                    return;
                }

                closeReceivedDialog();
                MoonCart.showLoading();

                try {
                    const response = await MoonCartAPI.updateOrderStatus(
                        orderId,
                        "delivered"
                    );
                    MoonCart.hideLoading();

                    if (response.success) {
                        MoonCart.showNotification(
                            "Order marked as delivered! Thank you for your order.",
                            "success"
                        );
                        // Reload orders to reflect the change
                        await loadUserOrders();
                    } else {
                        MoonCart.showNotification(
                            response.message || "Failed to update order status",
                            "error"
                        );
                    }
                } catch (error) {
                    MoonCart.hideLoading();
                    let errorMessage = "Failed to update order status";

                    // Try to extract error message from response
                    if (error.message) {
                        errorMessage = error.message;
                        // Check if it's a database migration issue
                        if (
                            errorMessage.includes("migration") ||
                            errorMessage.includes("Invalid status value") ||
                            errorMessage.includes("Data truncated") ||
                            errorMessage.includes("MIGRATION_REQUIRED")
                        ) {
                            // Try to auto-run migration via API
                            try {
                                MoonCart.showLoading();
                                const migrationResponse =
                                    await MoonCartAPI.request(
                                        "orders.php?action=migrate",
                                        {
                                            method: "GET",
                                        }
                                    );
                                MoonCart.hideLoading();

                                if (migrationResponse.success) {
                                    MoonCart.showNotification(
                                        "Database migrated successfully! Retrying...",
                                        "success"
                                    );
                                    // Retry the original request
                                    await confirmReceivedOrder();
                                    return;
                                } else {
                                    throw new Error("Migration failed");
                                }
                            } catch (migrationError) {
                                MoonCart.hideLoading();
                                // Auto-migration failed, show manual instructions
                                const migrationUrl =
                                    "http://localhost/Moon_Cart/backend/run_migration.php";
                                errorMessage =
                                    "Database migration required!\n\n";
                                errorMessage +=
                                    "Please visit this URL to run the migration automatically:\n\n";
                                errorMessage += migrationUrl + "\n\n";
                                errorMessage +=
                                    "Or run this SQL in phpMyAdmin:\n\n";
                                errorMessage +=
                                    "ALTER TABLE orders MODIFY COLUMN status ENUM('pending', 'confirmed', 'preparing', 'out_for_delivery', 'delivered', 'completed', 'cancelled') DEFAULT 'pending';";

                                // Show as alert for better visibility
                                alert(errorMessage);
                                MoonCart.showNotification(
                                    "Database needs to be updated. See alert for details.",
                                    "error"
                                );

                                // Optionally open migration page
                                if (
                                    confirm(
                                        "Would you like to open the migration page now?"
                                    )
                                ) {
                                    window.open(migrationUrl, "_blank");
                                }
                                return;
                            }
                        }
                    }

                    MoonCart.showNotification(errorMessage, "error");
                } finally {
                    currentReceivedOrderId = null;
                }
            }

            // Close dialog when clicking outside
            document.addEventListener("click", function (event) {
                const dialog = document.getElementById(
                    "received-confirm-dialog"
                );
                if (event.target === dialog) {
                    closeReceivedDialog();
                }
            });

            // Search orders
            function searchOrders() {
                const searchTerm =
                    document
                        .getElementById("order-search")
                        ?.value.toLowerCase() || "";
                const filtered = userOrders.filter((order) => {
                    const orderId = (
                        order.order_number ||
                        order.id ||
                        ""
                    ).toLowerCase();
                    const status = (order.status || "").toLowerCase();
                    return (
                        orderId.includes(searchTerm) ||
                        status.includes(searchTerm)
                    );
                });

                const container = document.getElementById(
                    "customer-orders-full"
                );
                if (!container) return;

                if (filtered.length === 0) {
                    container.innerHTML =
                        '<div class="empty-state"><h3>No orders found</h3><p>Try a different search term.</p></div>';
                    return;
                }

                container.innerHTML =
                    '<table class="data-table"><thead><tr><th>Order ID</th><th>Date</th><th>Items</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead><tbody>' +
                    filtered
                        .map((order) => {
                            const orderId = String(order.id || "").trim();
                            if (!orderId) return ""; // Skip if no order ID
                            const isConfirmed = order.status === "confirmed";
                            const receivedButton = isConfirmed
                                ? '<button class="btn btn-sm btn-success" onclick="markOrderAsReceived(\'' +
                                  orderId.replace(/'/g, "\\'") +
                                  '\')" style="background: #28a745; color: white; margin-left: 5px;"><i class="fas fa-check"></i> Received</button>'
                                : "";
                            return (
                                "<tr><td>#" +
                                (order.order_number || order.id)
                                    .toString()
                                    .substring(0, 12)
                                    .toUpperCase() +
                                "</td><td>" +
                                formatDate(
                                    order.created_at || order.orderDate
                                ) +
                                "</td><td>" +
                                (order.item_count || order.items?.length || 0) +
                                " items</td><td>৳" +
                                parseFloat(order.total).toFixed(2) +
                                '</td><td><span class="status-badge status-' +
                                order.status +
                                '">' +
                                order.status +
                                '</span></td><td><button class="btn btn-sm" onclick="viewOrderDetails(\'' +
                                orderId.replace(/'/g, "\\'") +
                                "')\">View</button>" +
                                receivedButton +
                                "</td></tr>"
                            );
                        })
                        .join("") +
                    "</tbody></table>";
            }

            // Show/hide sections
            function showSection(section) {
                document
                    .querySelectorAll(".dashboard-section")
                    .forEach((s) => (s.style.display = "none"));
                document
                    .querySelectorAll(".sidebar-link")
                    .forEach((l) => l.classList.remove("active"));
                document.getElementById(section + "-section").style.display =
                    "block";
                event.target.closest(".sidebar-link").classList.add("active");
            }

            // Logout function
            function logout() {
                localStorage.removeItem("mooncart_user");
                window.location.href = "index.html";
            }

            // Edit address
            function editAddress(addressId) {
                const address = userAddresses.find((a) => a.id === addressId);
                if (address) {
                    const newAddress = prompt(
                        "Edit address:",
                        address.address_line
                    );
                    if (newAddress && newAddress !== address.address_line) {
                        // In a real app, you would call the API to update
                        MoonCart.showNotification("Address updated", "success");
                        loadUserAddresses();
                    }
                }
            }

            // Initialize Charts
            function initCustomerCharts() {
                const spendingCtx = document.getElementById(
                    "customerSpendingChart"
                );
                if (spendingCtx && typeof Chart !== "undefined") {
                    new Chart(spendingCtx, {
                        type: "line",
                        data: {
                            labels: [
                                "Jan",
                                "Feb",
                                "Mar",
                                "Apr",
                                "May",
                                "Jun",
                                "Jul",
                            ],
                            datasets: [
                                {
                                    label: "Spending",
                                    data: [45, 65, 52, 78, 95, 68, 125],
                                    borderColor: "rgba(227, 30, 36, 1)",
                                    backgroundColor: "rgba(227, 30, 36, 0.1)",
                                    tension: 0.4,
                                    fill: true,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                        },
                    });
                }

                const categoryCtx = document.getElementById(
                    "customerCategoryChart"
                );
                if (categoryCtx && typeof Chart !== "undefined") {
                    new Chart(categoryCtx, {
                        type: "doughnut",
                        data: {
                            labels: [
                                "Food",
                                "Beverages",
                                "Medicine",
                                "Groceries",
                            ],
                            datasets: [
                                {
                                    data: [40, 25, 20, 15],
                                    backgroundColor: [
                                        "rgba(227, 30, 36, 0.8)",
                                        "rgba(255, 107, 53, 0.8)",
                                        "rgba(23, 162, 184, 0.8)",
                                        "rgba(40, 167, 69, 0.8)",
                                    ],
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                        },
                    });
                }
            }

            // Initialize on page load
            document.addEventListener("DOMContentLoaded", function () {
                loadDashboardData();
                initCustomerCharts();
            });
        </script>
    </body>
</html>
